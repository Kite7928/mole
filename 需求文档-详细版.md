# AI公众号自动写作助手 Pro - 详细需求文档

## 📋 文档信息

| 项目名称 | AI公众号自动写作助手 Pro (mole) |
|---------|--------------------------------|
| 文档版本 | v1.0 |
| 创建日期 | 2026年1月9日 |
| 文档类型 | 详细需求规格说明书 |
| 目标受众 | 产品经理、开发团队、测试团队、运维团队 |

---

## 🎯 1. 项目概述

### 1.1 项目背景

微信公众号内容创作面临以下痛点：
- **创作耗时**：传统手动创作一篇高质量文章需要75分钟
- **灵感枯竭**：选题困难，热点把握不准
- **格式繁琐**：Markdown转HTML、图片处理、排版耗时
- **多账号管理**：管理多个公众号账号操作重复
- **数据滞后**：无法实时监控文章表现

### 1.2 项目目标

构建一个基于AI的智能微信公众号内容生成与发布系统，实现：

- **效率提升**：将文章创作时间从75分钟缩短至9分钟（提升87.5%）
- **质量保证**：AI生成内容质量评分系统，确保内容质量
- **自动化运营**：支持90%-100%自动化程度，减少人工干预
- **多账号管理**：统一管理多个微信公众号账号
- **数据驱动**：实时监控文章表现，优化内容策略

### 1.3 核心价值主张

```
┌─────────────────────────────────────────────────────────────┐
│                     传统模式 vs AI模式                        │
├─────────────────────────────────────────────────────────────┤
│  传统模式: 选题(20min) → 写作(40min) → 排版(15min) = 75min  │
│  AI模式:   选择(1min) → 生成(5min) → 审核(3min) = 9min      │
│                                                             │
│  效率提升: 87.5% | 成本降低: 80% | 质量提升: 30%           │
└─────────────────────────────────────────────────────────────┘
```

---

## 👥 2. 用户角色与权限

### 2.1 用户角色定义

| 角色 | 描述 | 典型用户 |
|-----|------|---------|
| **超级管理员** | 系统最高权限，可管理所有账号和配置 | 企业CTO、技术负责人 |
| **内容运营** | 负责内容创作和发布，可管理多个公众号 | 新媒体运营、内容编辑 |
| **内容审核** | 负责内容审核和质量把控 | 内容总监、审核员 |
| **普通用户** | 只能查看数据，无操作权限 | 数据分析师、实习生 |

### 2.2 权限矩阵

```
┌─────────────────────────────────────────────────────────────────┐
│                    功能模块权限矩阵                              │
├──────────────┬─────────┬──────────────┬──────────────┬─────────┤
│   功能模块    │ 超级管理员 │  内容运营    │  内容审核    │ 普通用户 │
├──────────────┼─────────┼──────────────┼──────────────┼─────────┤
│ 仪表板查看   │   ✓     │      ✓       │      ✓       │    ✓    │
│ 文章创建     │   ✓     │      ✓       │      ✓       │    ✗    │
│ AI生成       │   ✓     │      ✓       │      ✓       │    ✗    │
│ 文章编辑     │   ✓     │      ✓       │      ✓       │    ✗    │
│ 文章发布     │   ✓     │      ✓       │      ✗       │    ✗    │
│ 草稿管理     │   ✓     │      ✓       │      ✓       │    ✗    │
│ 热点监控     │   ✓     │      ✓       │      ✓       │    ✓    │
│ 数据统计     │   ✓     │      ✓       │      ✓       │    ✓    │
│ 账号管理     │   ✓     │      ✗       │      ✗       │    ✗    │
│ 系统配置     │   ✓     │      ✗       │      ✗       │    ✗    │
│ 用户管理     │   ✓     │      ✗       │      ✗       │    ✗    │
│ API密钥管理  │   ✓     │      ✗       │      ✗       │    ✗    │
└──────────────┴─────────┴──────────────┴──────────────┴─────────┘
```

---

## 🎨 3. 功能需求

### 3.1 功能模块架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         前端界面层 (Next.js)                          │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────┐   │
│  │ 仪表板   │  │ 文章管理 │  │ 热点监控 │  │ 数据统计 │  │设置│   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┘   │
└───────┼────────────┼────────────┼────────────┼─────────────────────┘
        │            │            │            │
        └────────────┼────────────┼────────────┘
                     │            │
        ┌────────────▼────────────▼────────────┐
        │         后端API层 (FastAPI)          │
        ├─────────────────────────────────────┤
        │ ┌──────┐ ┌──────┐ ┌──────┐ ┌─────┐ │
        │ │文章API│ │新闻API│ │微信API│ │任务API│ │
        │ └──┬───┘ └──┬───┘ └──┬───┘ └──┬──┘ │
        └────┼────────┼────────┼────────┼────┘
             │        │        │        │
        ┌────▼────────▼────────▼────────▼────┐
        │           业务服务层                 │
        ├─────────────────────────────────────┤
        │ ┌──────┐ ┌──────┐ ┌──────┐ ┌─────┐ │
        │ │AI写作│ │新闻采集│ │微信服务│ │图片服务│ │
        │ └──┬───┘ └──┬───┘ └──┬───┘ └──┬──┘ │
        └────┼────────┼────────┼────────┼────┘
             │        │        │        │
        ┌────▼────────▼────────▼────────▼────┐
        │           数据持久层                 │
        ├─────────────────────────────────────┤
        │      PostgreSQL   │    Redis        │
        └─────────────────────────────────────┘
```

### 3.2 模块1：智能写作引擎

#### 3.2.1 功能描述

提供基于AI的智能内容生成能力，支持多模型切换和多种生成模式。

#### 3.2.2 用户故事

> 作为一名内容运营，我希望能够通过AI快速生成高质量的文章内容，以便在短时间内完成多篇内容创作。

#### 3.2.3 功能需求详情

| 需求ID | 需求名称 | 优先级 | 验收标准 |
|-------|---------|--------|---------|
| FR-1.1 | 多模型AI支持 | P0 | 支持OpenAI GPT-4、Anthropic Claude、DeepSeek、Google Gemini |
| FR-1.2 | 智能标题生成 | P0 | 一次生成5-10个标题，带点击率预测分数 |
| FR-1.3 | 深度内容创作 | P0 | 支持联网搜索，生成2000-3000字深度内容 |
| FR-1.4 | 内容优化功能 | P1 | 支持增强、精简、扩写、润色四种优化模式 |
| FR-1.5 | 质量评分系统 | P1 | 自动生成内容质量评分（0-100分） |
| FR-1.6 | 自定义提示词 | P2 | 支持用户自定义写作风格和内容要求 |

#### 3.2.4 业务流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     AI写作引擎业务流程                               │
└─────────────────────────────────────────────────────────────────────┘

用户输入主题/选择热点
        │
        ▼
┌───────────────────┐
│  选择AI模型       │
│  (GPT-4/Claude/   │
│   DeepSeek/Gemini)│
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  生成标题选项     │
│  (5-10个标题)     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  用户选择标题     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  生成正文内容     │
│  (可选:联网搜索)  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  内容质量评分     │
│  (0-100分)        │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  用户审核/编辑    │
└─────────┬─────────┘
          │
          ▼
    保存/发布
```

#### 3.2.5 界面原型

```
┌─────────────────────────────────────────────────────────────────────┐
│  AI写作引擎                                                          │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  选择AI模型:                                                 │   │
│  │  ○ GPT-4  ○ Claude 3.5  ○ DeepSeek  ○ Gemini Pro          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  输入主题/关键词:                                            │   │
│  │  ┌───────────────────────────────────────────────────────┐  │   │
│  │  │ AI大模型最新进展分析                                   │  │   │
│  │  └───────────────────────────────────────────────────────┘  │   │
│  │                                                             │   │
│  │  写作要求:                                                   │   │
│  │  ○ 深度分析  ○ 简洁明了  ○ 通俗易懂  ○ 专业严谨            │   │
│  │                                                             │   │
│  │  字数要求: [2000-3000字]                                    │   │
│  │                                                             │   │
│  │  [联网搜索]  [生成技术配图]  [添加数据图表]                  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  生成标题 (点击率预测):                                       │   │
│  │  1. GPT-4o发布：AI推理能力的新突破 [预测点击率: 85%] ✓       │   │
│  │  2. DeepSeek-V3：开源模型的新里程碑 [预测点击率: 78%]        │   │
│  │  3. Claude 3.5 Sonnet：长文本处理的王者 [预测点击率: 72%]    │   │
│  │  4. Gemini Pro：谷歌AI的最新答卷 [预测点击率: 68%]           │   │
│  │  5. 2024年AI大模型发展报告 [预测点击率: 65%]                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  生成内容预览:                                               │   │
│  │  ┌───────────────────────────────────────────────────────┐  │   │
│  │  │ [标题] GPT-4o发布：AI推理能力的新突破                   │  │   │
│  │  │                                                       │  │   │
│  │  │ [摘要] 本文深入分析GPT-4o的技术特性...                 │  │   │
│  │  │                                                       │  │   │
│  │  │ [正文]                                               │  │   │
│  │  │ ## 引言                                               │  │   │
│  │  │ 2024年5月，OpenAI发布了...                           │  │   │
│  │  │                                                       │  │   │
│  │  │ ... (更多内容)                                       │  │   │
│  │  └───────────────────────────────────────────────────────┘  │   │
│  │                                                             │   │
│  │  质量评分: 87/100  ✓                                        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  [重新生成]  [优化内容]  [编辑]  [保存草稿]  [直接发布]              │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.2.6 API接口定义

```typescript
// AI写作相关API

// 1. 生成标题
POST /api/articles/generate-titles
Request: {
  topic: string;
  ai_model: 'gpt-4' | 'claude-3.5' | 'deepseek' | 'gemini';
  count: number; // 5-10
}
Response: {
  titles: Array<{
    title: string;
    predicted_click_rate: number; // 0-100
  }>;
}

// 2. 生成内容
POST /api/articles/generate-content
Request: {
  title: string;
  ai_model: string;
  requirements: {
    style: 'deep' | 'simple' | 'popular' | 'professional';
    word_count: number;
    enable_search: boolean;
    generate_images: boolean;
  };
}
Response: {
  content: string;
  summary: string;
  quality_score: number;
  sources: string[]; // 参考来源
}

// 3. 优化内容
POST /api/articles/optimize-content
Request: {
  content: string;
  mode: 'enhance' | 'simplify' | 'expand' | 'polish';
}
Response: {
  optimized_content: string;
  changes_summary: string;
}
```

### 3.3 模块2：数据采集系统

#### 3.3.1 功能描述

实时监控主流科技媒体和社交平台的热点内容，提供智能选题推荐。

#### 3.3.2 用户故事

> 作为一名内容运营，我希望能够实时了解科技圈的热点话题，以便及时创作相关内容，提高文章曝光度。

#### 3.3.3 功能需求详情

| 需求ID | 需求名称 | 优先级 | 验收标准 |
|-------|---------|--------|---------|
| FR-2.1 | 多源数据采集 | P0 | 支持IT之家、36氪、百度、知乎、微博5个平台 |
| FR-2.2 | 实时热点监控 | P0 | 每5分钟自动更新热点数据 |
| FR-2.3 | 智能去重 | P0 | 自动识别和过滤重复内容 |
| FR-2.4 | 热度计算 | P1 | 基于发布时间、互动量计算热度分数 |
| FR-2.5 | 分类筛选 | P1 | 支持按分类、时间、热度筛选 |
| FR-2.6 | 自定义RSS | P2 | 支持用户添加自定义RSS源 |

#### 3.3.4 业务流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     数据采集系统业务流程                             │
└─────────────────────────────────────────────────────────────────────┘

定时任务触发 (每5分钟)
        │
        ▼
┌───────────────────┐
│  并行采集5个平台  │
│  ┌─────────────┐  │
│  │ IT之家      │  │
│  │ 36氪        │  │
│  │ 百度        │  │
│  │ 知乎        │  │
│  │ 微博        │  │
│  └─────────────┘  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  数据清洗         │
│  - 去除HTML标签   │
│  - 提取正文       │
│  - 提取图片       │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  智能去重         │
│  - 标题相似度     │
│  - 内容指纹       │
│  - URL去重        │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  热度计算         │
│  - 发布时间权重   │
│  - 互动量权重     │
│  - 平台权重       │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  存储到数据库     │
└─────────┬─────────┘
          │
          ▼
    推送给用户
```

#### 3.3.5 界面原型

```
┌─────────────────────────────────────────────────────────────────────┐
│  热点监控                                                            │
├─────────────────────────────────────────────────────────────────────┤
│  筛选: [全部] ▼  分类: [全部] ▼  时间: [24小时] ▼  [刷新] [自动刷新: 5分钟] │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 🔥 热度: 95  IT之家  2小时前                                │   │
│  │ GPT-4o发布：AI推理能力的新突破                               │   │
│  │ OpenAI今日正式发布GPT-4o，在推理能力上实现重大突破...       │   │
│  │ [查看详情]  [生成文章]  [收藏]                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 🔥 热度: 88  36氪  3小时前                                  │   │
│  │ DeepSeek-V3：开源模型的新里程碑                             │   │
│  │ DeepSeek今日发布V3版本，性能媲美GPT-4...                    │   │
│  │ [查看详情]  [生成文章]  [收藏]                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 🔥 热度: 82  知乎  5小时前                                  │   │
│  │ Claude 3.5 Sonnet：长文本处理的王者                         │   │
│  │ Anthropic发布Claude 3.5 Sonnet，支持20万token上下文...     │   │
│  │ [查看详情]  [生成文章]  [收藏]                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 🔥 热度: 75  百度  6小时前                                  │   │
│  │ Gemini Pro：谷歌AI的最新答卷                                │   │
│  │ Google发布Gemini Pro，多模态能力显著提升...                 │   │
│  │ [查看详情]  [生成文章]  [收藏]                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ 🔥 热度: 68  微博  8小时前                                  │   │
│  │ 2024年AI大模型发展报告                                      │   │
│  │ 知名机构发布2024年AI大模型发展报告...                       │   │
│  │ [查看详情]  [生成文章]  [收藏]                               │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  [加载更多]                                                           │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.3.6 API接口定义

```typescript
// 数据采集相关API

// 1. 获取热点列表
GET /api/news/hotspots?platform=all&category=all&hours=24
Response: {
  hotspots: Array<{
    id: number;
    title: string;
    summary: string;
    source: 'ithome' | '36kr' | 'baidu' | 'zhihu' | 'weibo';
    url: string;
    hot_score: number; // 0-100
    published_at: string;
    image_url?: string;
  }>;
}

// 2. 获取热点详情
GET /api/news/hotspots/:id
Response: {
  id: number;
  title: string;
  content: string;
  source: string;
  url: string;
  hot_score: number;
  published_at: string;
  images: string[];
  related_news: number[]; // 相关热点ID
}

// 3. 手动刷新热点
POST /api/news/refresh
Response: {
  success: boolean;
  new_count: number;
  updated_at: string;
}

// 4. 添加自定义RSS源
POST /api/news/rss-sources
Request: {
  name: string;
  url: string;
  category: string;
}
Response: {
  id: number;
  success: boolean;
}
```

### 3.4 模块3：图片处理系统

#### 3.4.1 功能描述

提供完整的图片处理能力，包括封面图生成、技术配图生成、图片搜索和智能优化。

#### 3.4.2 用户故事

> 作为一名内容运营，我希望能够自动生成和优化文章配图，以便节省找图和修图的时间。

#### 3.4.3 功能需求详情

| 需求ID | 需求名称 | 优先级 | 验收标准 |
|-------|---------|--------|---------|
| FR-3.1 | 封面图生成 | P0 | 基于文章标题自动生成封面图 |
| FR-3.2 | 技术配图生成 | P0 | 生成Canvas/SVG风格的技术示意图 |
| FR-3.3 | 图片搜索 | P1 | 通过AI搜索相关图片 |
| FR-3.4 | 智能裁剪 | P1 | 自动裁剪为2.35:1比例 |
| FR-3.5 | 图片优化 | P1 | 压缩、调色、加水印 |
| FR-3.6 | 图床上传 | P2 | 支持多种图床（阿里云OSS、腾讯云COS） |

#### 3.4.4 业务流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     图片处理系统业务流程                             │
└─────────────────────────────────────────────────────────────────────┘

用户选择图片类型
        │
        ├───────────┬───────────┬───────────┐
        ▼           ▼           ▼           ▼
   封面图生成   技术配图生成   图片搜索   用户上传
        │           │           │           │
        ▼           ▼           ▼           ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────┐
│ AI生成    │ │ Canvas生成│ │ AI搜索    │ │ 原图    │
│ (Pollinations)│ │ (SVG)    │ │ (Pollinations)│ │         │
└─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └────┬────┘
      │             │             │            │
      └─────────────┼─────────────┼────────────┘
                    │             │
                    ▼             ▼
              ┌─────────────────────┐
              │   智能裁剪          │
              │   (2.35:1比例)      │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │   图片优化          │
              │   - 压缩            │
              │   - 调色            │
              │   - 加水印          │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │   上传到图床        │
              └──────────┬──────────┘
                         │
                         ▼
                   返回图片URL
```

#### 3.4.5 界面原型

```
┌─────────────────────────────────────────────────────────────────────┐
│  图片处理                                                            │
├─────────────────────────────────────────────────────────────────────┤
│  文章标题: GPT-4o发布：AI推理能力的新突破                            │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  选择图片类型:                                               │   │
│  │  ○ AI封面生成  ○ 技术配图  ○ 图片搜索  ○ 本地上传          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  AI封面生成:                                                 │   │
│  │  风格: [科技感] ▼  颜色: [蓝色] ▼  [生成]                    │   │
│  │                                                             │   │
│  │  ┌───────────────────────────────────────────────────────┐  │   │
│  │  │                                                       │  │   │
│  │  │              [生成的封面图预览]                        │  │   │
│  │  │                                                       │  │   │
│  │  │                                                       │  │   │
│  │  └───────────────────────────────────────────────────────┘  │   │
│  │                                                             │   │
│  │  尺寸: 900x383 (2.35:1)  大小: 128KB                        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  技术配图:                                                   │   │
│  │  类型: [架构图] ▼  样式: [简约] ▼  [生成]                    │   │
│  │                                                             │   │
│  │  ┌───────────────────────────────────────────────────────┐  │   │
│  │  │                                                       │  │   │
│  │  │              [生成的技术配图预览]                      │  │   │
│  │  │                                                       │  │   │
│  │  │                                                       │  │   │
│  │  └───────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  图片搜索:                                                   │   │
│  │  关键词: [AI模型]  [搜索]                                    │   │
│  │                                                             │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐   │   │
│  │  │           │ │           │ │           │ │           │   │   │
│  │  │  图片1    │ │  图片2    │ │  图片3    │ │  图片4    │   │   │
│  │  │           │ │           │ │           │ │           │   │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  [重新生成]  [编辑]  [使用此图片]  [上传到图床]                        │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.4.6 API接口定义

```typescript
// 图片处理相关API

// 1. 生成封面图
POST /api/images/generate-cover
Request: {
  title: string;
  style: 'tech' | 'business' | 'creative' | 'minimal';
  color: string;
}
Response: {
  image_url: string;
  width: number;
  height: number;
  size: number;
}

// 2. 生成技术配图
POST /api/images/generate-diagram
Request: {
  type: 'architecture' | 'flowchart' | 'network' | 'data';
  style: 'simple' | 'detailed' | 'colorful' | 'minimal';
}
Response: {
  image_url: string;
  width: number;
  height: number;
  svg_content: string;
}

// 3. 搜索图片
POST /api/images/search
Request: {
  keyword: string;
  count: number;
}
Response: {
  images: Array<{
    url: string;
    thumbnail: string;
    width: number;
    height: number;
  }>;
}

// 4. 优化图片
POST /api/images/optimize
Request: {
  image_url: string;
  options: {
    crop: boolean;
    ratio: '2.35:1' | '16:9' | '1:1';
    compress: boolean;
    quality: number;
    watermark: boolean;
  };
}
Response: {
  optimized_url: string;
  original_url: string;
  size_before: number;
  size_after: number;
}

// 5. 上传到图床
POST /api/images/upload
Request: {
  image_url: string;
  provider: 'aliyun' | 'tencent' | 'qiniu';
}
Response: {
  success: boolean;
  url: string;
  provider: string;
}
```

### 3.5 模块4：微信集成系统

#### 3.5.1 功能描述

提供完整的微信公众号集成能力，支持多账号管理、草稿发布、定时发布等功能。

#### 3.5.2 用户故事

> 作为一名内容运营，我希望能够一键将文章发布到微信公众号，以便快速完成内容发布流程。

#### 3.5.3 功能需求详情

| 需求ID | 需求名称 | 优先级 | 验收标准 |
|-------|---------|--------|---------|
| FR-4.1 | 多账号管理 | P0 | 支持管理多个微信公众号账号 |
| FR-4.2 | Token智能缓存 | P0 | 自动刷新和缓存Access Token |
| FR-4.3 | 草稿发布 | P0 | 创建草稿并上传图片 |
| FR-4.4 | 定时发布 | P1 | 支持定时发布功能 |
| FR-4.5 | 发布状态查询 | P1 | 实时查询文章发布状态 |
| FR-4.6 | 数据同步 | P2 | 同步阅读量、点赞、分享数据 |

#### 3.5.4 业务流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     微信集成系统业务流程                             │
└─────────────────────────────────────────────────────────────────────┘

用户选择公众号
        │
        ▼
┌───────────────────┐
│  检查Token        │
│  - 是否过期       │
│  - 是否需要刷新   │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  上传封面图       │
│  → 获取media_id   │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  上传正文图片     │
│  → 获取media_ids  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  转换为HTML格式   │
│  (公众号格式)     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  创建草稿         │
│  → 获取draft_id   │
└─────────┬─────────┘
          │
          ├───────────┐
          │           ▼
          │    ┌──────────────┐
          │    │  直接发布    │
          │    └──────┬───────┘
          │           │
          │           ▼
          │    ┌──────────────┐
          │    │ 发布成功     │
          │    └──────────────┘
          │
          └───────────┐
                      ▼
               ┌──────────────┐
               │  保存草稿    │
               │  或          │
               │  定时发布    │
               └──────────────┘
```

#### 3.5.5 界面原型

```
┌─────────────────────────────────────────────────────────────────────┐
│  微信发布                                                            │
├─────────────────────────────────────────────────────────────────────┤
│  选择公众号: [科技前沿] ▼                                            │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  文章预览:                                                   │   │
│  │  ┌───────────────────────────────────────────────────────┐  │   │
│  │  │ [封面图]                                               │  │   │
│  │  │                                                       │  │   │
│  │  │                                                       │  │   │
│  │  └───────────────────────────────────────────────────────┘  │   │
│  │                                                             │   │
│  │  标题: GPT-4o发布：AI推理能力的新突破                       │   │
│  │                                                             │   │
│  │  摘要: 本文深入分析GPT-4o的技术特性...                     │   │
│  │                                                             │   │
│  │  正文:                                                       │   │
│  │  ## 引言                                                     │   │
│  │  2024年5月，OpenAI发布了...                                │   │
│  │                                                             │   │
│  │  ... (更多内容)                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  发布选项:                                                   │   │
│  │  ○ 立即发布                                                  │   │
│  │  ○ 保存草稿                                                  │   │
│  │  ○ 定时发布                                                  │   │
│  │     发布时间: [2026-01-09 10:00] 📅                         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  发布状态:                                                   │   │
│  │  ✓ 封面图上传成功                                            │   │
│  │  ✓ 正文图片上传成功 (3张)                                    │   │
│  │  ✓ HTML格式转换成功                                          │   │
│  │  ⏳ 等待发布...                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  [返回编辑]  [预览]  [发布]                                           │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.5.6 API接口定义

```typescript
// 微信集成相关API

// 1. 获取公众号列表
GET /api/wechat/accounts
Response: {
  accounts: Array<{
    id: number;
    name: string;
    app_id: string;
    avatar: string;
    status: 'active' | 'inactive';
  }>;
}

// 2. 创建草稿
POST /api/wechat/drafts
Request: {
  account_id: number;
  title: string;
  author: string;
  digest: string;
  content: string;
  cover_image_media_id: string;
  need_open_comment: boolean;
  only_fans_can_comment: boolean;
}
Response: {
  draft_id: string;
  media_id: string;
  success: boolean;
}

// 3. 发布文章
POST /api/wechat/publish
Request: {
  account_id: number;
  draft_id: string;
  publish_time?: string; // ISO 8601格式
}
Response: {
  article_id: string;
  success: boolean;
  publish_time: string;
}

// 4. 查询发布状态
GET /api/wechat/articles/:article_id/status
Response: {
  article_id: string;
  status: 'publishing' | 'published' | 'failed';
  read_count: number;
  like_count: number;
  share_count: number;
}

// 5. 同步文章数据
POST /api/wechat/sync
Request: {
  account_id: number;
  article_ids: string[];
}
Response: {
  success: boolean;
  updated_count: number;
}
```

### 3.6 模块5：任务调度系统

#### 3.6.1 功能描述

基于Celery的分布式任务队列，支持灵活的定时任务和后台任务执行。

#### 3.6.2 用户故事

> 作为一名内容运营，我希望能够设置定时任务，以便在指定时间自动采集热点和发布文章。

#### 3.6.3 功能需求详情

| 需求ID | 需求名称 | 优先级 | 验收标准 |
|-------|---------|--------|---------|
| FR-5.1 | 定时热点采集 | P0 | 每5分钟自动采集热点 |
| FR-5.2 | 定时文章发布 | P1 | 支持定时发布文章 |
| FR-5.3 | 任务监控 | P1 | 实时监控任务执行状态 |
| FR-5.4 | 任务重试 | P1 | 失败任务自动重试 |
| FR-5.5 | 任务日志 | P2 | 记录任务执行日志 |
| FR-5.6 | 手动触发 | P2 | 支持手动触发任务 |

#### 3.6.4 业务流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     任务调度系统业务流程                             │
└─────────────────────────────────────────────────────────────────────┘

Celery Beat调度器
        │
        ▼
┌───────────────────┐
│  定时任务队列     │
│  ┌─────────────┐  │
│  │ 热点采集    │  │ (每5分钟)
│  │ 文章发布    │  │ (定时)
│  │ 数据同步    │  │ (每小时)
│  │ 维护任务    │  │ (每天)
│  └─────────────┘  │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  Celery Worker    │
│  (任务执行器)     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  执行任务         │
│  - 采集热点       │
│  - 发布文章       │
│  - 同步数据       │
└─────────┬─────────┘
          │
          ├───────────┐
          │           ▼
          │    ┌──────────────┐
          │    │  执行成功    │
          │    └──────┬───────┘
          │           │
          │           ▼
          │    ┌──────────────┐
          │    │ 更新状态     │
          │    └──────────────┘
          │
          └───────────┐
                      ▼
               ┌──────────────┐
               │  执行失败    │
               └──────┬───────┘
                      │
                      ▼
               ┌──────────────┐
               │  自动重试    │
               │  (最多3次)   │
               └──────────────┘
```

#### 3.6.5 界面原型

```
┌─────────────────────────────────────────────────────────────────────┐
│  任务监控 (Flower)                                                   │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Workers: 3个活跃  Tasks: 15个运行中  Queue: 5个待处理      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  定时任务:                                                   │   │
│  │  任务名称              | 调度时间      | 状态  | 下次执行    │   │
│  │  ---------------------------------------------------------  │   │
│  │  采集热点新闻         | */5 * * * *   | ✓运行 | 2分钟后     │   │
│  │  同步文章数据         | 0 * * * *     | ✓运行 | 58分钟后    │   │
│  │  定时发布文章         | 0 10 * * *    | ✓运行 | 10:00       │   │
│  │  每日维护任务         | 0 3 * * *     | ✓运行 | 03:00       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  运行中任务:                                                 │   │
│  │  任务ID           | 任务名称        | 进度   | 开始时间      │   │
│  │  ---------------------------------------------------------  │   │
│  │  abc123           | 采集IT之家     | 60%    | 10:00:15     │   │
│  │  def456           | 生成文章内容   | 30%    | 10:00:30     │   │
│  │  ghi789           | 上传图片       | 90%    | 10:00:45     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  任务日志:                                                   │   │
│  │  [2026-01-09 10:00:00] 采集热点任务开始                     │   │
│  │  [2026-01-09 10:00:30] 采集到15条热点                       │   │
│  │  [2026-01-09 10:00:35] 采集热点任务完成                     │   │
│  │  [2026-01-09 10:01:00] 文章生成任务开始                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  [刷新]  [查看详情]  [手动触发]  [停止任务]                          │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.6.6 API接口定义

```typescript
// 任务调度相关API

// 1. 获取任务列表
GET /api/tasks?status=running
Response: {
  tasks: Array<{
    id: string;
    name: string;
    status: 'pending' | 'running' | 'success' | 'failed';
    progress: number;
    started_at: string;
    completed_at?: string;
  }>;
}

// 2. 手动触发任务
POST /api/tasks/trigger
Request: {
  task_name: 'fetch_hotspots' | 'sync_articles' | 'publish_article';
  params?: object;
}
Response: {
  task_id: string;
  success: boolean;
}

// 3. 获取任务详情
GET /api/tasks/:task_id
Response: {
  id: string;
  name: string;
  status: string;
  progress: number;
  result?: object;
  error?: string;
  started_at: string;
  completed_at?: string;
}

// 4. 停止任务
POST /api/tasks/:task_id/stop
Response: {
  success: boolean;
  message: string;
}

// 5. 获取定时任务列表
GET /api/tasks/scheduled
Response: {
  scheduled_tasks: Array<{
    id: string;
    name: string;
    schedule: string; // Cron表达式
    enabled: boolean;
    next_run: string;
  }>;
}
```

### 3.7 模块6：数据统计系统

#### 3.7.1 功能描述

提供全面的数据统计和分析能力，帮助用户了解文章表现和优化内容策略。

#### 3.7.2 用户故事

> 作为一名内容运营，我希望能够查看文章的阅读量、点赞、分享等数据，以便了解内容表现并优化策略。

#### 3.7.3 功能需求详情

| 需求ID | 需求名称 | 优先级 | 验收标准 |
|-------|---------|--------|---------|
| FR-6.1 | 文章数据统计 | P0 | 统计阅读量、点赞、分享等数据 |
| FR-6.2 | 数据可视化 | P1 | 提供图表展示数据趋势 |
| FR-6.3 | 数据导出 | P1 | 支持导出Excel/CSV格式 |
| FR-6.4 | 数据对比 | P2 | 支持多篇文章数据对比 |
| FR-6.5 | 数据分析 | P2 | 提供数据分析和建议 |
| FR-6.6 | 实时更新 | P2 | 数据实时更新 |

#### 3.7.4 业务流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     数据统计系统业务流程                             │
└─────────────────────────────────────────────────────────────────────┘

定时同步任务 (每小时)
        │
        ▼
┌───────────────────┐
│  从微信API获取    │
│  文章数据         │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  存储到数据库     │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  数据聚合计算     │
│  - 日统计         │
│  - 周统计         │
│  - 月统计         │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  生成图表         │
│  - 趋势图         │
│  - 对比图         │
│  - 饼图           │
└─────────┬─────────┘
          │
          ▼
    展示给用户
```

#### 3.7.5 界面原型

```
┌─────────────────────────────────────────────────────────────────────┐
│  数据统计                                                            │
├─────────────────────────────────────────────────────────────────────┤
│  时间范围: [最近7天] ▼  公众号: [科技前沿] ▼  [刷新] [导出]          │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  概览数据:                                                   │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │   │
│  │  │ 总阅读量 │  │ 总点赞数 │  │ 总分享数 │  │ 平均阅读 │   │   │
│  │  │  125,680 │  │  3,456   │  │  1,234   │  │   2,513  │   │   │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  阅读量趋势:                                                 │   │
│  │  ┌───────────────────────────────────────────────────────┐  │   │
│  │  │                                                       │  │   │
│  │  │  20k ┤     ╭────╮                                    │  │   │
│  │  │  15k ┤   ╭─╯    ╰──╮                                 │  │   │
│  │  │  10k ┤ ╭─╯         ╰─╮                               │  │   │
│  │  │   5k ┤─╯             ╰──╮                            │  │   │
│  │  │    0 └─────────────────╰───────────────────────      │  │   │
│  │  │       1/3  1/4  1/5  1/6  1/7  1/8  1/9            │  │   │
│  │  └───────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  文章排行:                                                   │   │
│  │  排名 | 标题                          | 阅读量  | 点赞  | 分享 │   │
│  │  ---------------------------------------------------------  │   │
│  │   1   | GPT-4o发布：AI推理能力...    | 25,680  | 890   | 320 │   │
│  │   2   | DeepSeek-V3：开源模型...      | 18,450  | 654   | 210 │   │
│  │   3   | Claude 3.5 Sonnet：长文本...  | 15,230  | 520   | 180 │   │
│  │   4   | Gemini Pro：谷歌AI的...       | 12,890  | 450   | 150 │   │
│  │   5   | 2024年AI大模型发展报告...     | 10,560  | 380   | 120 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  数据分析:                                                   │   │
│  │  • 本周阅读量比上周增长 15.3% ↑                              │   │
│  │  • 平均点赞率为 2.8%，高于行业平均 2.5%                      │   │
│  │  • 分享率为 1.0%，建议增加引导分享的CTA                      │   │
│  │  • 最佳发布时间为 10:00-11:00                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.7.6 API接口定义

```typescript
// 数据统计相关API

// 1. 获取概览数据
GET /api/statistics/overview?days=7
Response: {
  total_read_count: number;
  total_like_count: number;
  total_share_count: number;
  avg_read_count: number;
  growth_rate: {
    read: number;
    like: number;
    share: number;
  };
}

// 2. 获取趋势数据
GET /api/statistics/trend?days=7&metric=read_count
Response: {
  dates: string[];
  values: number[];
}

// 3. 获取文章排行
GET /api/statistics/ranking?days=7&limit=10
Response: {
  articles: Array<{
    id: number;
    title: string;
    read_count: number;
    like_count: number;
    share_count: number;
    published_at: string;
  }>;
}

// 4. 导出数据
GET /api/statistics/export?days=7&format=excel
Response: {
  download_url: string;
  file_name: string;
}

// 5. 获取数据分析
GET /api/statistics/analysis?days=7
Response: {
  insights: string[];
  recommendations: string[];
  best_publish_time: string;
  avg_metrics: {
    like_rate: number;
    share_rate: number;
    read_time: number;
  };
}
```

---

## ⚙️ 4. 非功能需求

### 4.1 性能需求

| 需求ID | 需求名称 | 需求描述 | 验收标准 |
|-------|---------|---------|---------|
| NFR-1 | 响应时间 | API响应时间 | < 500ms (95th percentile) |
| NFR-2 | 并发用户 | 支持并发用户数 | ≥ 1000并发用户 |
| NFR-3 | AI生成速度 | AI内容生成速度 | < 30秒/篇 |
| NFR-4 | 数据采集速度 | 热点数据采集速度 | < 2分钟/次 |
| NFR-5 | 数据库性能 | 数据库查询性能 | < 100ms (95th percentile) |

### 4.2 可用性需求

| 需求ID | 需求名称 | 需求描述 | 验收标准 |
|-------|---------|---------|---------|
| NFR-6 | 系统可用性 | 系统正常运行时间 | ≥ 99.5% |
| NFR-7 | 故障恢复 | 故障恢复时间 | < 30分钟 |
| NFR-8 | 数据备份 | 数据备份频率 | 每日备份 |
| NFR-9 | 灾难恢复 | 灾难恢复时间 | < 4小时 |

### 4.3 安全性需求

| 需求ID | 需求名称 | 需求描述 | 验收标准 |
|-------|---------|---------|---------|
| NFR-10 | 身份认证 | 用户身份认证 | 支持JWT Token |
| NFR-11 | 权限控制 | 基于角色的访问控制 | RBAC |
| NFR-12 | 数据加密 | 敏感数据加密 | AES-256 |
| NFR-13 | API安全 | API接口安全 | HTTPS + Rate Limit |
| NFR-14 | 日志审计 | 操作日志审计 | 记录所有关键操作 |

### 4.4 可扩展性需求

| 需求ID | 需求名称 | 需求描述 | 验收标准 |
|-------|---------|---------|---------|
| NFR-15 | 水平扩展 | 支持水平扩展 | 无状态设计 |
| NFR-16 | 数据库扩展 | 数据库读写分离 | 支持主从复制 |
| NFR-17 | 缓存扩展 | Redis集群支持 | 支持Redis Cluster |
| NFR-18 | 任务队列扩展 | Celery集群支持 | 支持多Worker |

### 4.5 可维护性需求

| 需求ID | 需求名称 | 需求描述 | 验收标准 |
|-------|---------|---------|---------|
| NFR-19 | 代码质量 | 代码规范 | ESLint + Pylint |
| NFR-20 | 测试覆盖率 | 单元测试覆盖率 | ≥ 80% |
| NFR-21 | 文档完整性 | API文档 | OpenAPI/Swagger |
| NFR-22 | 监控告警 | 系统监控 | Prometheus + Grafana |

---

## 🏗️ 5. 技术架构

### 5.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         系统架构图                                   │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                          用户层                                       │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  Web浏览器   │  │  移动端      │  │  API客户端   │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
└─────────┼──────────────────┼──────────────────┼─────────────────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                          前端层 (Next.js)                             │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  React组件   │  │  状态管理    │  │  路由管理    │              │
│  │  (shadcn/ui) │  │  (Zustand)  │  │  (App Router)│              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                          网关层 (Nginx)                               │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  反向代理    │  │  负载均衡    │  │  SSL终结     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                          应用层 (FastAPI)                             │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  API路由     │  │  中间件      │  │  认证授权    │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                          服务层                                       │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  AI写作服务  │  │  新闻采集    │  │  微信服务    │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  图片服务    │  │  任务调度    │  │  数据统计    │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└────────────────────────────┬────────────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────────────┐
│                          数据层                                       │
├─────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ PostgreSQL   │  │  Redis       │  │  文件存储    │              │
│  │  (主数据)    │  │  (缓存)      │  │  (OSS/COS)   │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 技术栈

#### 5.2.1 前端技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| Next.js | 14.1.0 | React框架 |
| React | 18.2.0 | UI库 |
| TypeScript | 5.x | 类型系统 |
| TailwindCSS | 3.x | CSS框架 |
| shadcn/ui | latest | UI组件库 |
| Zustand | 4.4.7 | 状态管理 |
| React Query | 5.17.9 | 数据获取 |
| Axios | 1.6.5 | HTTP客户端 |
| Recharts | 2.10.3 | 图表库 |
| Tiptap | latest | 富文本编辑器 |

#### 5.2.2 后端技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| Python | 3.10+ | 编程语言 |
| FastAPI | 0.109.0 | Web框架 |
| SQLAlchemy | 2.0.25 | ORM |
| PostgreSQL | 15+ | 关系数据库 |
| Redis | 7+ | 缓存/消息队列 |
| Celery | 5.3.6 | 任务队列 |
| OpenAI SDK | 1.10.0 | OpenAI API |
| Anthropic SDK | 0.18.1 | Claude API |
| Playwright | 1.41.0 | 网页自动化 |
| Pillow | 10.2.0 | 图片处理 |
| OpenCV | latest | 图像处理 |
| httpx | latest | HTTP客户端 |
| BeautifulSoup | latest | HTML解析 |

#### 5.2.3 部署技术栈

| 技术 | 版本 | 用途 |
|-----|------|------|
| Docker | 24+ | 容器化 |
| Docker Compose | 2.x | 容器编排 |
| Nginx | 1.24+ | 反向代理 |
| Vercel | latest | 前端部署 |
| Railway | latest | 后端部署 |
| Cloudflare Workers | latest | 边缘计算 |
| GitHub Actions | latest | CI/CD |

### 5.3 数据库设计

#### 5.3.1 核心数据表

```sql
-- 文章表
CREATE TABLE articles (
    id SERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    summary TEXT,
    content TEXT NOT NULL,
    html_content TEXT,
    status VARCHAR(50) NOT NULL,
    source VARCHAR(50) NOT NULL,
    ai_model VARCHAR(50),
    cover_image_url TEXT,
    cover_image_media_id VARCHAR(100),
    wechat_draft_id VARCHAR(100),
    wechat_article_id VARCHAR(100),
    read_count INTEGER DEFAULT 0,
    like_count INTEGER DEFAULT 0,
    share_count INTEGER DEFAULT 0,
    tags JSONB,
    quality_score DECIMAL(5,2),
    predicted_click_rate DECIMAL(5,2),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    published_at TIMESTAMP
);

-- 新闻表
CREATE TABLE news (
    id SERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    summary TEXT,
    content TEXT,
    source VARCHAR(50) NOT NULL,
    url TEXT NOT NULL,
    hot_score DECIMAL(5,2),
    published_at TIMESTAMP NOT NULL,
    image_url TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(source, url)
);

-- 微信账号表
CREATE TABLE wechat_accounts (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    app_id VARCHAR(100) NOT NULL,
    app_secret VARCHAR(200) NOT NULL,
    access_token TEXT,
    token_expires_at TIMESTAMP,
    avatar TEXT,
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 任务表
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    status VARCHAR(50) NOT NULL,
    progress INTEGER DEFAULT 0,
    result JSONB,
    error TEXT,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 用户表
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(200) UNIQUE NOT NULL,
    password_hash VARCHAR(200) NOT NULL,
    role VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 5.4 API设计规范

#### 5.4.1 RESTful API设计

```
基础URL: https://api.example.com/v1

资源命名规范:
- 使用复数名词: /articles, /news, /users
- 使用小写字母和连字符: /user-profiles
- 使用版本控制: /v1/articles

HTTP方法规范:
- GET: 获取资源
- POST: 创建资源
- PUT: 更新整个资源
- PATCH: 部分更新资源
- DELETE: 删除资源

响应格式:
{
  "success": true,
  "data": {},
  "message": "",
  "timestamp": "2026-01-09T10:00:00Z"
}

错误响应:
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": {}
  },
  "timestamp": "2026-01-09T10:00:00Z"
}
```

#### 5.4.2 API端点清单

| 方法 | 端点 | 描述 |
|-----|------|------|
| GET | /health | 健康检查 |
| GET | /articles | 获取文章列表 |
| POST | /articles | 创建文章 |
| GET | /articles/:id | 获取文章详情 |
| PUT | /articles/:id | 更新文章 |
| DELETE | /articles/:id | 删除文章 |
| POST | /articles/generate-titles | 生成标题 |
| POST | /articles/generate-content | 生成内容 |
| POST | /articles/optimize-content | 优化内容 |
| GET | /news/hotspots | 获取热点列表 |
| GET | /news/hotspots/:id | 获取热点详情 |
| POST | /news/refresh | 刷新热点 |
| POST | /images/generate-cover | 生成封面图 |
| POST | /images/generate-diagram | 生成技术配图 |
| POST | /images/search | 搜索图片 |
| POST | /images/optimize | 优化图片 |
| POST | /images/upload | 上传到图床 |
| GET | /wechat/accounts | 获取公众号列表 |
| POST | /wechat/drafts | 创建草稿 |
| POST | /wechat/publish | 发布文章 |
| GET | /wechat/articles/:id/status | 查询发布状态 |
| POST | /wechat/sync | 同步文章数据 |
| GET | /tasks | 获取任务列表 |
| POST | /tasks/trigger | 手动触发任务 |
| GET | /tasks/:id | 获取任务详情 |
| POST | /tasks/:id/stop | 停止任务 |
| GET | /tasks/scheduled | 获取定时任务列表 |
| GET | /statistics/overview | 获取概览数据 |
| GET | /statistics/trend | 获取趋势数据 |
| GET | /statistics/ranking | 获取文章排行 |
| GET | /statistics/export | 导出数据 |
| GET | /statistics/analysis | 获取数据分析 |

---

## 🚀 6. 部署方案

### 6.1 部署架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         部署架构图                                   │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                          用户访问                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       CDN (Cloudflare)                               │
│                    静态资源加速 + DDoS防护                            │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       负载均衡 (Nginx)                                │
│                         SSL终结                                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
            ┌─────────────────┼─────────────────┐
            ▼                 ▼                 ▼
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│   Vercel         │ │   Railway        │ │   Docker         │
│   (前端)         │ │   (后端)         │ │   (自托管)       │
│   Next.js        │ │   FastAPI        │ │   完整服务       │
│   静态资源       │ │   PostgreSQL     │ │   PostgreSQL     │
│                  │ │   Redis          │ │   Redis          │
│                  │ │   Celery Worker  │ │   Celery Worker  │
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

### 6.2 部署方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|-----|------|------|---------|
| **Vercel + Railway** | 零配置、自动扩容、免费额度 | 后台任务受限、成本较高 | 快速原型、小规模应用 |
| **Docker Compose** | 完整控制、成本低、适合后台任务 | 需要运维、需要服务器 | 生产环境、大规模应用 |
| **Cloudflare Workers** | 全球加速、边缘计算 | 功能受限、不适合复杂逻辑 | 静态资源、简单API |

### 6.3 推荐部署方案

#### 方案1：Vercel + Railway（推荐快速部署）

```yaml
# 部署步骤
1. 前端部署到Vercel
   - 连接GitHub仓库
   - 自动构建和部署
   - 配置环境变量

2. 后端部署到Railway
   - 创建PostgreSQL数据库
   - 创建Redis实例
   - 部署FastAPI应用
   - 部署Celery Worker

3. 配置域名
   - 在Vercel配置自定义域名
   - 在Railway配置API域名
   - 配置CORS
```

#### 方案2：Docker Compose（推荐生产环境）

```yaml
# docker-compose.production.yml
version: '3.8'

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: mole
      POSTGRES_USER: mole
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: always

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data
    restart: always

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      DATABASE_URL: postgresql://mole:${DB_PASSWORD}@postgres:5432/mole
      REDIS_URL: redis://redis:6379
    depends_on:
      - postgres
      - redis
    restart: always

  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A app.tasks.celery_app worker --loglevel=info
    environment:
      DATABASE_URL: postgresql://mole:${DB_PASSWORD}@postgres:5432/mole
      REDIS_URL: redis://redis:6379
    depends_on:
      - postgres
      - redis
    restart: always

  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A app.tasks.celery_app beat --loglevel=info
    environment:
      DATABASE_URL: postgresql://mole:${DB_PASSWORD}@postgres:5432/mole
      REDIS_URL: redis://redis:6379
    depends_on:
      - postgres
      - redis
    restart: always

  flower:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: celery -A app.tasks.celery_app flower --port=5555
    environment:
      REDIS_URL: redis://redis:6379
    depends_on:
      - redis
    ports:
      - "5555:5555"
    restart: always

  nginx:
    image: nginx:1.24-alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
    restart: always

volumes:
  postgres_data:
  redis_data:
```

### 6.4 环境变量配置

```bash
# .env.production

# 数据库配置
DATABASE_URL=postgresql://mole:password@postgres:5432/mole
REDIS_URL=redis://redis:6379

# AI API配置
OPENAI_API_KEY=sk-xxx
ANTHROPIC_API_KEY=sk-ant-xxx
DEEPSEEK_API_KEY=sk-xxx
GEMINI_API_KEY=xxx

# 微信配置
WECHAT_APP_ID=xxx
WECHAT_APP_SECRET=xxx

# 图床配置
ALIYUN_OSS_ACCESS_KEY=xxx
ALIYUN_OSS_SECRET_KEY=xxx
ALIYUN_OSS_BUCKET=xxx

# JWT配置
JWT_SECRET=xxx
JWT_EXPIRE_HOURS=24

# 应用配置
APP_NAME=AI公众号自动写作助手 Pro
APP_URL=https://api.example.com
FRONTEND_URL=https://example.com

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=/var/log/mole/app.log
```

---

## 📊 7. 测试策略

### 7.1 测试类型

| 测试类型 | 描述 | 工具 |
|---------|------|------|
| 单元测试 | 测试单个函数/类 | pytest, Jest |
| 集成测试 | 测试模块间交互 | pytest, Supertest |
| API测试 | 测试API接口 | Postman, pytest |
| E2E测试 | 测试完整流程 | Playwright, Cypress |
| 性能测试 | 测试系统性能 | Locust, JMeter |
| 安全测试 | 测试安全性 | OWASP ZAP |

### 7.2 测试覆盖率要求

| 模块 | 最低覆盖率 | 目标覆盖率 |
|-----|-----------|-----------|
| 前端组件 | 70% | 85% |
| 后端API | 75% | 90% |
| 业务服务 | 80% | 95% |
| 数据模型 | 85% | 95% |

### 7.3 测试用例示例

```python
# 测试AI写作服务
def test_generate_titles():
    # Given
    topic = "AI大模型最新进展"
    ai_model = "gpt-4"
    count = 5

    # When
    result = ai_writer.generate_titles(topic, ai_model, count)

    # Then
    assert len(result.titles) == count
    assert all(t.predicted_click_rate >= 0 for t in result.titles)
    assert all(t.predicted_click_rate <= 100 for t in result.titles)

# 测试新闻采集服务
def test_fetch_hotspots():
    # Given
    platform = "ithome"

    # When
    result = news_fetcher.fetch_hotspots(platform)

    # Then
    assert len(result.hotspots) > 0
    assert all(h.hot_score >= 0 for h in result.hotspots)
    assert all(h.hot_score <= 100 for h in result.hotspots)

# 测试微信服务
def test_create_draft():
    # Given
    account_id = 1
    title = "测试文章"
    content = "<p>测试内容</p>"

    # When
    result = wechat_service.create_draft(account_id, title, content)

    # Then
    assert result.success
    assert result.draft_id is not None
```

---

## 📅 8. 项目里程碑

### 8.1 项目时间表

```
阶段1：需求分析与设计 (2周)
├── 需求调研
├── 架构设计
├── 数据库设计
└── API设计

阶段2：核心功能开发 (4周)
├── AI写作引擎
├── 数据采集系统
├── 图片处理系统
└── 微信集成系统

阶段3：高级功能开发 (3周)
├── 任务调度系统
├── 数据统计系统
└── 用户管理系统

阶段4：测试与优化 (2周)
├── 单元测试
├── 集成测试
├── 性能优化
└── 安全加固

阶段5：部署与上线 (1周)
├── 环境配置
├── 数据迁移
├── 灰度发布
└── 正式上线

总计：12周
```

### 8.2 里程碑检查点

| 里程碑 | 交付物 | 完成时间 |
|-------|-------|---------|
| M1: 需求冻结 | 需求文档、架构设计文档 | 第2周 |
| M2: 核心功能完成 | AI写作、数据采集、图片处理、微信集成 | 第6周 |
| M3: 功能完成 | 所有功能模块完成 | 第9周 |
| M4: 测试完成 | 测试报告、Bug修复 | 第11周 |
| M5: 正式上线 | 生产环境部署、用户培训 | 第12周 |

---

## 📝 9. 附录

### 9.1 术语表

| 术语 | 定义 |
|-----|------|
| AI | 人工智能 |
| API | 应用程序接口 |
| Celery | 分布式任务队列 |
| FastAPI | Python Web框架 |
| GPT | Generative Pre-trained Transformer |
| JWT | JSON Web Token |
| Next.js | React框架 |
| ORM | 对象关系映射 |
| PostgreSQL | 关系数据库 |
| Redis | 内存数据库 |
| RSS | Really Simple Syndication |
| shadcn/ui | React UI组件库 |

### 9.2 参考文档

- [Next.js官方文档](https://nextjs.org/docs)
- [FastAPI官方文档](https://fastapi.tiangolo.com/)
- [Celery官方文档](https://docs.celeryq.dev/)
- [微信公众号API文档](https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html)
- [OpenAI API文档](https://platform.openai.com/docs)

### 9.3 变更记录

| 版本 | 日期 | 作者 | 变更内容 |
|-----|------|------|---------|
| v1.0 | 2026-01-09 | iFlow CLI | 初始版本 |

---

## ✍️ 10. 签字确认

| 角色 | 姓名 | 签字 | 日期 |
|-----|------|------|------|
| 产品经理 | | | |
| 技术负责人 | | | |
| 项目经理 | | | |
| 开发负责人 | | | |
| 测试负责人 | | | |

---

**文档结束**