{
  "$schema": "https://railway.app/railway.schema.json",
  "name": "AI公众号自动写作助手 Pro",
  "description": "智能微信公众号内容生成与发布系统",
  "build": {
    "builder": "NIXPACKS"
  },
  "services": [
    {
      "name": "backend",
      "source": {
        "type": "github"
      },
      "healthcheckPath": "/api/health",
      "healthcheckTimeout": 300,
      "restartPolicyType": "ON_FAILURE",
      "restartPolicyMaxRetries": 10,
      "env": {
        "DATABASE_URL": {
          "required": true,
          "description": "PostgreSQL 数据库连接字符串"
        },
        "REDIS_URL": {
          "required": true,
          "description": "Redis 连接字符串"
        },
        "SECRET_KEY": {
          "required": true,
          "description": "应用密钥（使用 openssl rand -hex 32 生成）"
        },
        "OPENAI_API_KEY": {
          "required": true,
          "description": "OpenAI API Key"
        },
        "OPENAI_BASE_URL": {
          "default": "https://api.openai.com/v1",
          "description": "OpenAI API Base URL"
        },
        "WECHAT_APP_ID": {
          "required": true,
          "description": "微信公众号 App ID"
        },
        "WECHAT_APP_SECRET": {
          "required": true,
          "description": "微信公众号 App Secret"
        }
      }
    },
    {
      "name": "celery-worker",
      "source": {
        "type": "github"
      },
      "startCommand": "cd backend && celery -A app.tasks.celery_app worker --loglevel=info --concurrency=2",
      "env": {
        "DATABASE_URL": {
          "required": true
        },
        "REDIS_URL": {
          "required": true
        },
        "SECRET_KEY": {
          "required": true
        },
        "OPENAI_API_KEY": {
          "required": true
        },
        "OPENAI_BASE_URL": {
          "default": "https://api.openai.com/v1"
        },
        "WECHAT_APP_ID": {
          "required": true
        },
        "WECHAT_APP_SECRET": {
          "required": true
        }
      }
    },
    {
      "name": "celery-beat",
      "source": {
        "type": "github"
      },
      "startCommand": "cd backend && celery -A app.tasks.celery_app beat --loglevel=info",
      "env": {
        "DATABASE_URL": {
          "required": true
        },
        "REDIS_URL": {
          "required": true
        },
        "SECRET_KEY": {
          "required": true
        }
      }
    }
  ],
  "databases": [
    {
      "name": "postgres",
      "type": "postgresql",
      "plan": "starter"
    },
    {
      "name": "redis",
      "type": "redis",
      "plan": "starter"
    }
  ]
}
