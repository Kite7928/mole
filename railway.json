{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "healthcheckPath": "/api/health",
    "healthcheckTimeout": 300,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  },
  "services": {
    "celery-worker": {
      "buildCommand": "pip install -r requirements.txt",
      "startCommand": "celery -A app.tasks.celery_app worker --loglevel=info --concurrency=2",
      "env": {
        "DATABASE_URL": "${{DATABASE_URL}}",
        "REDIS_URL": "${{REDIS_URL}}",
        "SECRET_KEY": "${{SECRET_KEY}}",
        "OPENAI_API_KEY": "${{OPENAI_API_KEY}}",
        "OPENAI_BASE_URL": "${{OPENAI_BASE_URL}}",
        "WECHAT_APP_ID": "${{WECHAT_APP_ID}}",
        "WECHAT_APP_SECRET": "${{WECHAT_APP_SECRET}}"
      }
    },
    "celery-beat": {
      "buildCommand": "pip install -r requirements.txt",
      "startCommand": "celery -A app.tasks.celery_app beat --loglevel=info",
      "env": {
        "DATABASE_URL": "${{DATABASE_URL}}",
        "REDIS_URL": "${{REDIS_URL}}",
        "SECRET_KEY": "${{SECRET_KEY}}"
      }
    },
    "flower": {
      "buildCommand": "pip install -r requirements.txt",
      "startCommand": "celery -A app.tasks.celery_app flower --port=5555 --basic_auth=${{FLOWER_USER}}:${{FLOWER_PASSWORD}}",
      "env": {
        "REDIS_URL": "${{REDIS_URL}}",
        "FLOWER_USER": "admin",
        "FLOWER_PASSWORD": "${{FLOWER_PASSWORD}}"
      },
      "ports": [
        {
          "port": 5555,
          "handlers": ["HTTP"]
        }
      ]
    }
  }
}