# 系统架构图

## 一、整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐           │
│  │   Web 浏览器      │  │   移动端 APP     │  │   API 客户端     │           │
│  │  (Chrome/Edge)   │  │  (React Native)  │  │   (Postman)     │           │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓ HTTPS/WSS
┌─────────────────────────────────────────────────────────────────────────────┐
│                            接入层 (Gateway Layer)                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐           │
│  │    Nginx         │  │   Load Balancer  │  │   CDN            │           │
│  │  (反向代理)       │  │   (负载均衡)      │  │   (静态资源)      │           │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                           应用层 (Application Layer)                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         前端应用 (Frontend)                             │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │  配置面板     │  │  主功能区     │  │  日志面板     │               │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                        ↓ HTTP/WebSocket                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         后端应用 (Backend)                             │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │  API Gateway  │  │  Auth Service│  │  Task Service│               │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │  LLM Service  │  │  Image Service│  │  WeChat Service│             │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                           服务层 (Service Layer)                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  DeepSeek API│  │  Gemini API  │  │  OpenAI API  │  │  IT之家 API   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  百度资讯 API │  │  百度热搜 API │  │  DuckDuckGo  │  │  Pollinations │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  微信公众号 API│  │  WebGallery  │  │  OSS/COS     │  │  CDN          │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据层 (Data Layer)                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  PostgreSQL  │  │  Redis       │  │  File System │  │  Object Store│   │
│  │  (主数据库)    │  │  (缓存)       │  │  (本地文件)    │  │  (OSS/COS)    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                           基础设施层 (Infrastructure)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  Docker      │  │  Kubernetes  │  │  Monitoring  │  │  Logging     │   │
│  │  (容器化)      │  │  (编排)       │  │  (监控)       │  │  (日志)       │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 二、核心业务流程图

### 2.1 全自动写作流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户启动流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 1: 选择选题来源                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                     │
│  │  手动输入主题  │  │  AI科技热点   │  │  百度全网热搜  │                     │
│  │  ↓           │  │  ↓           │  │  ↓           │                     │
│  │  用户输入     │  │  调用API获取  │  │  调用API获取  │                     │
│  │  ↓           │  │  ↓           │  │  ↓           │                     │
│  │  确定主题     │  │  热点列表展示  │  │  热搜榜单展示  │                     │
│  └──────────────┘  └──────────────┘  └──────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 2: 生成标题                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  调用 LLM 服务 (DeepSeek/Gemini/OpenAI)                               │  │
│  │  ↓                                                                     │  │
│  │  生成多个爆款标题方案                                                   │  │
│  │  ↓                                                                     │  │
│  │  展示标题列表供用户选择                                                  │  │
│  │  ↓                                                                     │  │
│  │  确定最终标题                                                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 3: 生成正文                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  检查"深度研究"开关                                                     │  │
│  │  ↓                                                                     │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                            │  │
│  │  │  开启            │  │  关闭            │                            │  │
│  │  │  ↓              │  │  ↓              │                            │  │
│  │  │  联网搜索        │  │  直接生成        │                            │  │
│  │  │  ↓              │  │  ↓              │                            │  │
│  │  │  收集资料        │  │  基于通用知识    │                            │  │
│  │  │  ↓              │  │                  │                            │  │
│  │  └────────┬────────┘  └────────┬────────┘                            │  │
│  │           ↓                    ↓                                      │  │
│  │           └────────────────────┘                                      │  │
│  │                    ↓                                                  │  │
│  │  调用 LLM 服务生成结构化正文                                          │  │
│  │  ↓                                                                     │  │
│  │  内容格式化和优化                                                       │  │
│  │  ↓                                                                     │  │
│  │  正文完成                                                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 4: 处理封面图                                                            │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  尝试下载原图                                                           │  │
│  │  ↓                                                                     │  │
│  │  验证图片尺寸和质量                                                     │  │
│  │  ↓                                                                     │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                            │  │
│  │  │  尺寸合格        │  │  尺寸过小        │                            │  │
│  │  │  ↓              │  │  ↓              │                            │  │
│  │  │  自动裁剪        │  │  搜索替代图片    │                            │  │
│  │  │  ↓              │  │  ↓              │                            │  │
│  │  │  上传微信        │  │  DuckDuckGo/    │                            │  │
│  │  │  ↓              │  │  Pollinations   │                            │  │
│  │  │  获取 media_id  │  │  ↓              │                            │  │
│  │  │                  │  │  下载新图片      │                            │  │
│  │  │                  │  │  ↓              │                            │  │
│  │  │                  │  │  裁剪上传        │                            │  │
│  │  └─────────────────┘  └─────────────────┘                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 5: 生成技术配图                                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  检查"生成技术配图"开关                                                 │  │
│  │  ↓                                                                     │  │
│  │  从正文中提取核心概念                                                   │  │
│  │  ↓                                                                     │  │
│  │  调用图片生成服务 (Pollinations AI)                                    │  │
│  │  ↓                                                                     │  │
│  │  生成 Canvas/SVG 风格技术图                                            │  │
│  │  ↓                                                                     │  │
│  │  上传微信获取 media_id                                                 │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│  Step 6: 发布草稿                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  获取微信 access_token                                                 │  │
│  │  ↓                                                                     │  │
│  │  检查缓存                                                               │  │
│  │  ↓                                                                     │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                            │  │
│  │  │  缓存有效        │  │  缓存失效        │                            │  │
│  │  │  ↓              │  │  ↓              │                            │  │
│  │  │  使用缓存token  │  │  请求新token     │                            │  │
│  │  │                  │  │  ↓              │                            │  │
│  │  │                  │  │  更新缓存        │                            │  │
│  │  └─────────────────┘  └─────────────────┘                            │  │
│  │                    ↓                                                  │  │
│  │  构建草稿数据 (标题、摘要、正文、封面图、技术图)                        │  │
│  │  ↓                                                                     │  │
│  │  调用微信API创建草稿                                                   │  │
│  │  ↓                                                                     │  │
│  │  获取 Draft ID                                                         │  │
│  │  ↓                                                                     │  │
│  │  流程完成                                                               │  │
│  └──────────────────────────────────────────────────────────────────────────┘
```

## 三、数据流图

### 3.1 热点获取数据流

```─────────────────────────┘  │
└─────────────────────────────────────────────────
用户请求热点
    ↓
后端接收请求
    ↓
检查缓存 (Redis)
    ↓
┌─────────────┐
│ 缓存命中?   │
└─────────────┘
    ↓ Yes         ↓ No
返回缓存数据   调用外部API
    ↓            ↓
              IT之家API / 百度API
              ↓
              解析响应数据
              ↓
              格式化热点列表
              ↓
              写入缓存 (TTL: 1小时)
              ↓
              返回数据
```

### 3.2 内容生成数据流

```
用户提供主题
    ↓
调用 LLM 服务
    ↓
┌─────────────────┐
│ 深度研究开启?   │
└─────────────────┘
    ↓ Yes         ↓ No
联网搜索         直接生成
    ↓            ↓
收集资料         调用 LLM
    ↓            ↓
整理信息         生成内容
    ↓            ↓
调用 LLM         ↓
    ↓            ↓
生成内容         ↓
    ↓            ↓
格式优化         ↓
    ↓            ↓
返回结果         ↓
```

### 3.3 图片处理数据流

```
需要处理图片
    ↓
┌─────────────────┐
│ 图片来源?       │
└─────────────────┘
    ↓ 下载         ↓ 搜索
下载原图         搜索关键词
    ↓            ↓
尺寸检测         调用搜索API
    ↓            ↓
┌─────────────┐  ↓
│ 尺寸合格?   │  下载搜索结果
└─────────────┘  ↓
    ↓ Yes         ↓
裁剪适配         尺寸检测
    ↓            ↓
上传微信         ┌─────────────┐
    ↓            │ 尺寸合格?   │
获取 media_id   └─────────────┘
    ↓            ↓ Yes         ↓ No
返回结果        裁剪适配      搜索替代
                ↓            ↓
                上传微信     ↓
                ↓            ↓
                获取 media_id↓
                ↓            ↓
                返回结果     ↓
```

## 四、部署架构图

### 4.1 生产环境部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户访问层                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                     │
│  │  CDN 节点     │  │  DNS 解析     │  │  防火墙       │                     │
│  │  (静态资源)    │  │  (域名解析)    │  │  (安全防护)    │                     │
│  └──────────────┘  └──────────────┘  └──────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              负载均衡层                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                     │
│  │  Nginx LB    │  │  SLB/ELB     │  │  API Gateway  │                     │
│  │  (反向代理)    │  │  (云负载均衡)  │  │  (API网关)    │                     │
│  └──────────────┘  └──────────────┘  └──────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              应用服务层                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │  前端服务容器     │  │  后端服务容器     │  │  Worker 容器     │          │
│  │  (Nginx + SPA)   │  │  (Node.js API)   │  │  (异步任务)      │          │
│  │  ┌────────────┐  │  │  ┌────────────┐  │  │  ┌────────────┐  │          │
│  │  │  Pod 1     │  │  │  │  Pod 1     │  │  │  │  Pod 1     │  │          │
│  │  │  Pod 2     │  │  │  │  Pod 2     │  │  │  │  Pod 2     │  │          │
│  │  │  Pod 3     │  │  │  │  Pod 3     │  │  │  │  Pod 3     │  │          │
│  │  └────────────┘  │  │  └────────────┘  │  │  └────────────┘  │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据存储层                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │  PostgreSQL      │  │  Redis Cluster   │  │  Object Storage  │          │
│  │  (主数据库)       │  │  (缓存集群)       │  │  (对象存储)       │          │
│  │  ┌────────────┐  │  │  ┌────────────┐  │  │  ┌────────────┐  │          │
│  │  │  Master    │  │  │  │  Master    │  │  │  │  OSS/COS   │  │          │
│  │  │  Slave 1   │  │  │  │  Slave 1   │  │  │  └────────────┘  │          │
│  │  │  Slave 2   │  │  │  │  Slave 2   │  │  │                  │          │
│  │  └────────────┘  │  │  └────────────┘  │  │                  │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                              监控和运维层                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  Prometheus  │  │  Grafana     │  │  ELK Stack   │  │  Sentry      │   │
│  │  (监控指标)    │  │  (可视化)     │  │  (日志分析)    │  │  (错误追踪)    │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 开发环境部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Docker Compose 环境                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  docker-compose.yml                                                   │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │  frontend    │  │  backend     │  │  postgres    │               │  │
│  │  │  (React)     │  │  (Node.js)   │  │  (数据库)     │               │  │
│  │  │  Port: 80   │  │  Port: 3000  │  │  Port: 5432  │               │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │  redis       │  │  nginx       │  │  volume      │               │  │
│  │  │  (缓存)       │  │  (反向代理)    │  │  (数据持久化)  │               │  │
│  │  │  Port: 6379  │  │  Port: 80    │  │               │               │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 五、时序图

### 5.1 全自动写作时序图

```
用户        前端          后端          LLM服务        搜索服务       微信API
 │            │             │              │              │              │
 │─启动流程──→│             │              │              │              │
 │            │─API请求────→│              │              │              │
 │            │             │─获取热点────→│              │              │
 │            │             │              │              │              │
 │            │             │←─热点列表───│              │              │
 │            │←─展示热点───│              │              │              │
 │            │             │              │              │              │
 │─选择主题──→│             │              │              │              │
 │            │─生成标题───→│              │              │              │
 │            │             │─调用LLM────→│              │              │
 │            │             │              │              │              │
 │            │             │←─标题列表───│              │              │
 │            │←─展示标题───│              │              │              │
 │            │             │              │              │              │
 │─确定标题──→│             │              │              │              │
 │            │─生成正文───→│              │              │              │
 │            │             │─联网搜索─────→│              │              │
 │            │             │              │              │              │
 │            │             │←─搜索结果───│              │              │
 │            │             │─调用LLM────→│              │              │
 │            │             │              │              │              │
 │            │             │←─正文内容───│              │              │
 │            │←─展示进度───│              │              │              │
 │            │             │              │              │              │
 │            │             │─处理图片─────→│              │              │
 │            │             │              │              │              │
 │            │             │←─media_id───│              │              │
 │            │←─展示进度───│              │              │              │
 │            │             │              │              │              │
 │            │             │─创建草稿────────────────────────────────→│
 │            │             │              │              │              │
 │            │             │←─Draft ID────────────────────────────────│
 │            │←─完成───────│              │              │              │
 │            │             │              │              │              │
```

## 六、状态机图

### 6.1 任务状态机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              任务状态机                                       │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────┐
    │  PENDING│ (待处理)
    └────┬────┘
         │
         ↓
    ┌─────────┐
    │ RUNNING │ (运行中)
    └────┬────┘
         │
    ┌────┴────┐
    ↓         ↓
┌───────┐ ┌──────────┐
│SUCCESS│ │  FAILED  │ (成功) (失败)
└───────┘ └──────────┘
           │
           ↓
      ┌──────────┐
      │  RETRY   │ (重试)
      └────┬─────┘
           │
           ↓
      ┌─────────┐
      │ RUNNING │
      └─────────┘
```

### 6.2 微信 Token 状态机

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Token 状态机                                      │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────┐
    │  NEW    │ (新建)
    └────┬────┘
         │
         ↓
    ┌─────────┐
    │  CACHED │ (已缓存)
    └────┬────┘
         │
    ┌────┴────┐
    ↓         ↓
┌───────┐ ┌──────────┐
│VALID  │ │ EXPIRED  │ (有效) (过期)
└───┬───┘ └────┬─────┘
    │          │
    │          ↓
    │     ┌──────────┐
    │     │ REFRESH  │ (刷新中)
    │     └────┬─────┘
    │          │
    │          ↓
    │     ┌─────────┐
    └────→│  CACHED │
          └─────────┘
```

---

## 七、总结

以上架构图展示了系统的完整设计，包括：

1. **整体架构**: 从用户层到基础设施层的完整分层
2. **业务流程**: 全自动写作的详细步骤
3. **数据流**: 热点获取、内容生成、图片处理的数据流向
4. **部署架构**: 生产环境和开发环境的部署方案
5. **时序图**: 组件间的交互时序
6. **状态机**: 任务状态和 Token 状态的转换

通过这些架构图，可以清晰地理解系统的设计和实现细节。